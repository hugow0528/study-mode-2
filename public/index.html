<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Study Mode | HKDSE</title>
    
    <!-- 1. Browser Tab Icon (Favicon) -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%238899a6'%3E%3Cpath d='M12 2a10 10 0 00-9.95 9.1c-.04.55.39 1 .95.95A10 10 0 0012 22a10 10 0 0010-10c0-5.52-4.48-10-10-10zm0 18a8 8 0 110-16 8 8 0 010 16zm-2-8a2 2 0 100-4 2 2 0 000 4zm4 0a2 2 0 100-4 2 2 0 000 4z'/%3E%3C/svg%3E">
    
    <!-- 2. Apple/Android Home Screen Icon -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%238899a6'%3E%3Cpath d='M12 2a10 10 0 00-9.95 9.1c-.04.55.39 1 .95.95A10 10 0 0012 22a10 10 0 0010-10c0-5.52-4.48-10-10-10zm0 18a8 8 0 110-16 8 8 0 010 16zm-2-8a2 2 0 100-4 2 2 0 000 4zm4 0a2 2 0 100-4 2 2 0 000 4z'/%3E%3C/svg%3E">
    
    <!-- 3. Safari Pinned Tab Icon -->
    <link rel="mask-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%238899a6'%3E%3Cpath d='M12 2a10 10 0 00-9.95 9.1c-.04.55.39 1 .95.95A10 10 0 0012 22a10 10 0 0010-10c0-5.52-4.48-10-10-10zm0 18a8 8 0 110-16 8 8 0 010 16zm-2-8a2 2 0 100-4 2 2 0 000 4zm4 0a2 2 0 100-4 2 2 0 000 4z'/%3E%3C/svg%3E" color="#6B705C">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+HK:wght@300;400;500;700&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>

    <style>
        :root {
            /* Light Mode (Wabi-sabi) */
            --bg-main: #F4F1EA; --bg-sidebar: #EBE7E0; --bg-card: #FFFFFF; --text-primary: #3A3633; --text-secondary: #8C8680; --accent: #6B705C; --accent-hover: #585C4B; --border: #D8D4CD; --msg-user-bg: #E3E0D9; --msg-ai-bg: #FFFFFF; --shadow: rgba(0,0,0,0.05); --radius: 16px;
        }
        [data-theme="dark"] {
            /* Dark Mode */
            --bg-main: #1C1C1E; --bg-sidebar: #151517; --bg-card: #2C2C2E; --text-primary: #E5E5E7; --text-secondary: #8E8E93; --accent: #5E6A75; --accent-hover: #4A5560; --border: #38383A; --msg-user-bg: #3A3A3C; --msg-ai-bg: #2C2C2E; --shadow: rgba(0,0,0,0.2);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; transition: background 0.2s ease, color 0.2s ease, border-color 0.2s ease; }
        body { margin: 0; font-family: 'Noto Sans HK', sans-serif; background: var(--bg-main); color: var(--text-primary); height: 100dvh; display: flex; overflow: hidden; }
        
        /* Layout & Sidebar */
        #sidebar { width: 280px; background: var(--bg-sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 100; flex-shrink: 0; }
        #main { flex: 1; display: flex; flex-direction: column; position: relative; width: 100%; min-width: 0; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .new-chat-btn { width: 100%; padding: 12px; background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border); border-radius: var(--radius); font-weight: 500; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 2px 4px var(--shadow); }
        .new-chat-btn:hover { border-color: var(--accent); color: var(--accent); }
        #history-list { list-style: none; padding: 10px; margin: 0; overflow-y: auto; flex: 1; }
        .history-item { padding: 12px; margin-bottom: 4px; border-radius: 8px; cursor: pointer; color: var(--text-secondary); font-size: 0.9rem; display: flex; justify-content: space-between; align-items: center; }
        .history-item:hover, .history-item.active { background: rgba(0,0,0,0.03); color: var(--text-primary); font-weight: 500; }
        [data-theme="dark"] .history-item:hover, [data-theme="dark"] .history-item.active { background: rgba(255,255,255,0.05); }
        .history-item .actions { display: none; gap: 4px; }
        .history-item:hover .actions { display: flex; }
        .icon-btn { background: none; border: none; cursor: pointer; color: var(--text-secondary); padding: 4px; border-radius: 4px; }
        .icon-btn:hover { color: var(--text-primary); background: rgba(0,0,0,0.05); }
        .sidebar-footer { padding: 15px; border-top: 1px solid var(--border); display: flex; gap: 10px; align-items: center; cursor: pointer; }
        .avatar { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; border: 1px solid var(--border); }
        
        /* Top Bar & NEW Model Selector */
        .top-bar { padding: 15px 20px; display: flex; align-items: center; border-bottom: 1px solid var(--border); background: var(--bg-main); z-index: 10; gap: 10px; }
        .model-selector-container { margin-left: auto; position: relative; }
        .model-selector-btn { background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border); padding: 8px 12px; border-radius: 8px; font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .model-selector-btn:hover { border-color: var(--accent); }
        .model-selector-btn::after { content: 'â–¼'; font-size: 0.6rem; opacity: 0.5; }
        .model-selector-menu { position: absolute; top: 110%; right: 0; background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; box-shadow: 0 4px 20px var(--shadow); z-index: 101; list-style: none; padding: 8px; margin: 0; min-width: 200px; opacity: 0; transform: translateY(-10px); pointer-events: none; transition: opacity 0.2s ease, transform 0.2s ease; }
        .model-selector-menu.active { opacity: 1; transform: translateY(0); pointer-events: auto; }
        .model-item { padding: 10px 12px; border-radius: 6px; cursor: pointer; }
        .model-item:hover { background: rgba(0,0,0,0.05); }
        [data-theme="dark"] .model-item:hover { background: rgba(255,255,255,0.08); }
        .model-item.selected { font-weight: 600; color: var(--accent); }

        /* Chat Area */
        #chat-container { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 120px; scroll-behavior: smooth; }
        .message-row { display: flex; margin-bottom: 24px; animation: fadeIn 0.3s ease; gap: 12px; max-width: 900px; margin-left: auto; margin-right: auto; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message-row.user { flex-direction: row-reverse; }
        .message-avatar { width: 32px; height: 32px; border-radius: 50%; flex-shrink: 0; margin-top: 4px; object-fit: cover; }
        .message-content-wrapper { display: flex; flex-direction: column; max-width: 80%; }
        .message-row.user .message-content-wrapper { align-items: flex-end; }
        .message-bubble { padding: 14px 18px; border-radius: var(--radius); line-height: 1.6; font-size: 1rem; word-wrap: break-word; position: relative; box-shadow: 0 1px 2px var(--shadow); }
        .user .message-bubble { background: var(--msg-user-bg); color: var(--text-primary); border-bottom-right-radius: 4px; }
        .ai .message-bubble { background: var(--msg-ai-bg); color: var(--text-primary); border-bottom-left-radius: 4px; }
        .message-actions { display: flex; gap: 8px; margin-top: 4px; opacity: 0; transition: opacity 0.2s; font-size: 0.8rem; }
        .message-row:hover .message-actions { opacity: 1; }
        .action-link { cursor: pointer; color: var(--text-secondary); text-decoration: underline; }
        .action-link:hover { color: var(--accent); }
        .message-bubble code { font-family: 'JetBrains Mono', monospace; font-size: 0.9em; background: rgba(0,0,0,0.06); padding: 2px 5px; border-radius: 4px; }
        [data-theme="dark"] .message-bubble code { background: rgba(255,255,255,0.1); }
        .message-bubble pre { background: #222; color: #eee; padding: 15px; border-radius: 8px; overflow-x: auto; margin: 10px 0; }

        /* Input Area */
        .input-area { position: absolute; bottom: 0; left: 0; right: 0; padding: 20px; background: linear-gradient(to top, var(--bg-main) 85%, transparent); display: flex; justify-content: center; }
        .input-wrapper { width: 100%; max-width: 800px; background: var(--bg-card); border-radius: 24px; padding: 8px 16px; display: flex; align-items: flex-end; gap: 10px; border: 1px solid var(--border); box-shadow: 0 4px 12px var(--shadow); transition: border-color 0.2s; }
        .input-wrapper:focus-within { border-color: var(--accent); }
        textarea { flex: 1; background: transparent; border: none; color: var(--text-primary); resize: none; max-height: 200px; padding: 12px 0; font-size: 1rem; font-family: inherit; outline: none; line-height: 1.5; }
        .send-btn { background: var(--accent); color: white; border: none; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; margin-bottom: 6px; transition: transform 0.1s; }
        .send-btn:active { transform: scale(0.95); }
        .send-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* Modals */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 1000; backdrop-filter: blur(4px); }
        .modal.active { opacity: 1; pointer-events: all; }
        .modal-content { background: var(--bg-card); padding: 30px; border-radius: 24px; width: 90%; max-width: 420px; border: 1px solid var(--border); box-shadow: 0 10px 30px rgba(0,0,0,0.2); transition: transform 0.3s; transform: scale(0.95); }
        .modal.active .modal-content { transform: scale(1); }
        .modal h2 { margin-top: 0; color: var(--accent); font-weight: 500; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 0.9rem; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; background: var(--bg-main); border: 1px solid var(--border); color: var(--text-primary); padding: 12px; border-radius: 12px; font-family: inherit; outline: none; }
        .form-group input:focus { border-color: var(--accent); }
        .primary-btn { width: 100%; padding: 12px; background: var(--accent); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; margin-top: 10px; }
        .close-btn { position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-secondary); }
        
        /* Responsive */
        .menu-btn { display: none; background: none; border: none; color: var(--text-primary); font-size: 1.5rem; cursor: pointer; }
        @media (max-width: 768px) {
            #sidebar { position: fixed; left: -280px; height: 100%; box-shadow: 10px 0 30px rgba(0,0,0,0.2); }
            #sidebar.open { transform: translateX(280px); }
            .menu-btn { display: block; }
            .top-bar { padding: 10px 15px; }
            .message-bubble { max-width: 95%; }
            .message-row { padding: 0; }
        }
    </style>
</head>
<body data-theme="light">

    <!-- Sidebar -->
    <aside id="sidebar">
        <div class="sidebar-header">
            <h2 style="margin:0; font-size:1.1rem; color:var(--accent); letter-spacing:1px;">STUDY MODE</h2>
            <button class="icon-btn" onclick="toggleTheme()" title="Toggle Theme">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-4.97-4.03-9-9-9zM12 19c-3.86 0-7-3.14-7-7s3.14-7 7-7 7 3.14 7 7-3.14 7-7 7z"/></svg>
            </button>
        </div>
        <div style="padding: 10px 10px 0 10px;">
            <button class="new-chat-btn" onclick="createNewChat()">
                <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"></path></svg>
                New Topic
            </button>
        </div>
        <ul id="history-list"></ul>
        <div class="sidebar-footer" onclick="openProfile()">
            <img src="" id="profile-img-sidebar" class="avatar" alt="User">
            <div style="flex:1; overflow:hidden; padding-left: 5px;">
                <div id="profile-name-sidebar" style="font-weight:600; font-size:0.95rem;">Student</div>
                <div id="profile-form-sidebar" style="font-size:0.8rem; color:var(--text-secondary);">S5</div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main id="main">
        <div class="top-bar">
            <button class="menu-btn" onclick="toggleSidebar()">â˜°</button>
            <div class="model-selector-container">
                <button id="model-selector-btn" class="model-selector-btn">Gemini 3 Pro</button>
                <ul id="model-selector-menu" class="model-selector-menu">
                    <!-- Model items will be generated here by JS -->
                </ul>
            </div>
        </div>
        <div id="chat-container"></div>
        <div class="input-area">
            <div class="input-wrapper">
                <textarea id="user-input" placeholder="Enter for new line, Ctrl+Enter to send" rows="1"></textarea>
                <button id="send-btn" class="send-btn" onclick="sendMessage()">
                    <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"></path></svg>
                </button>
            </div>
        </div>
    </main>

    <!-- Profile Modal -->
    <div id="profile-modal" class="modal">
        <div class="modal-content" style="position:relative;">
            <button class="close-btn" onclick="closeProfile()">Ã—</button>
            <h2>My Profile</h2>
            <div style="text-align:center; margin-bottom:20px;">
                <img id="p-preview" class="avatar" style="width:80px; height:80px;" src="" alt="Preview">
                <br>
                <input type="file" id="p-upload" accept="image/*" style="display:none;" onchange="handleImageUpload(this)">
                <button onclick="document.getElementById('p-upload').click()" style="margin-top:10px; background:transparent; border:1px solid var(--accent); color:var(--accent); padding:5px 10px; border-radius:8px; cursor:pointer;">Change Photo</button>
            </div>
            <div class="form-group"><label>Display Name</label><input type="text" id="p-name"></div>
            <div class="form-group"><label>Form</label><select id="p-form"><option>S1</option><option>S2</option><option>S3</option><option>S4</option><option>S5</option><option>S6</option></select></div>
            <div class="form-group"><label>Goals / Weaknesses</label><textarea id="p-about" rows="3" placeholder="e.g. Weak in Probability, Aiming for 5* in Chem"></textarea></div>
            <button class="primary-btn" onclick="saveProfile()">Save Changes</button>
        </div>
    </div>

    <script>
        // --- Constants & State ---
        const AI_AVATAR = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%238899a6'%3E%3Cpath d='M12 2a10 10 0 00-9.95 9.1c-.04.55.39 1 .95.95A10 10 0 0012 22a10 10 0 0010-10c0-5.52-4.48-10-10-10zm0 18a8 8 0 110-16 8 8 0 010 16zm-2-8a2 2 0 100-4 2 2 0 000 4zm4 0a2 2 0 100-4 2 2 0 000 4z'/%3E%3C/svg%3E";
        const DEFAULT_USER_IMG = "https://api.dicebear.com/7.x/initials/svg?seed=Student";
        const AVAILABLE_MODELS = {
            "gemini-3-pro-preview": "Gemini 3 Pro",
            "gemini-2.5-pro": "Gemini 2.5 Pro",
            "llama-3.3-70b": "Llama 3.3 70B",
            "llama3.1-8b": "Llama 3.1 8B",
            "gpt-oss-120b": "GPT OSS 120B",
            "qwen-3-235b-a22b-instruct-2507": "Qwen 3 235B",
            "qwen-3-32b": "Qwen 3 32B",
            "zai-glm-4.6": "Z.ai GLM 4.6"
        };
        
        let chatHistories = JSON.parse(localStorage.getItem('hkdse_chats_v4')) || {};
        let activeChatId = null;
        let userProfile = JSON.parse(localStorage.getItem('hkdse_profile_v4')) || { name: 'Student', form: 'S5', about: '', avatar: DEFAULT_USER_IMG };
        let theme = localStorage.getItem('hkdse_theme_v4') || 'light';
        let currentModel = localStorage.getItem('hkdse_model_v4') || 'gemini-3-pro-preview';
        
        // --- DOM Elements ---
        const getEl = id => document.getElementById(id);
        const chatContainer = getEl('chat-container'), userInput = getEl('user-input'), sendBtn = getEl('send-btn'), historyList = getEl('history-list'), modelSelectorBtn = getEl('model-selector-btn'), modelSelectorMenu = getEl('model-selector-menu');

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            setupInitialUI();
            setupEventListeners();
            loadSession();
        });

        function setupInitialUI() {
            setTheme(theme);
            loadProfileUI();
            renderModelSelector();
        }

        function setupEventListeners() {
            userInput.addEventListener('input', () => { userInput.style.height = 'auto'; userInput.style.height = `${userInput.scrollHeight}px`; });
            userInput.addEventListener('keydown', e => { if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) { e.preventDefault(); sendMessage(); } });
            modelSelectorBtn.addEventListener('click', () => modelSelectorMenu.classList.toggle('active'));
            document.addEventListener('click', e => { if (!modelSelectorBtn.contains(e.target) && !modelSelectorMenu.contains(e.target)) modelSelectorMenu.classList.remove('active'); });
        }
        
        function loadSession() {
            const lastId = localStorage.getItem('hkdse_active_id_v4');
            if(lastId && chatHistories[lastId]) {
                loadChat(lastId);
            } else {
                createNewChat();
            }
            renderHistoryList();
        }
        
        // --- Core Rendering & Data Cleaning (BUG FIX) ---
        function renderMessage(role, text, index) {
            const cleanHTML = (() => {
                if (role === 'ai') {
                    const cleanText = (text || '').replace(/<think>[\s\S]*?<\/think>/gi, '').trim();
                    return DOMPurify.sanitize(marked.parse(cleanText));
                }
                return text; // User text is plain
            })();

            const actionsHTML = role === 'user' ? `<div class="message-actions"><span class="action-link" onclick="editMessage(${index})">Edit & Resend</span></div>` : '';

            const avatarHTML = `<img src="${role === 'user' ? userProfile.avatar : AI_AVATAR}" class="message-avatar">`;
            const contentHTML = `
                <div class="message-content-wrapper">
                    <div class="message-bubble">${cleanHTML}</div>
                    ${actionsHTML}
                </div>`;
            
            return `
                <div class="message-row ${role === 'user' ? 'user' : 'ai'}">
                    ${role === 'ai' ? avatarHTML + contentHTML : contentHTML + avatarHTML}
                </div>`;
        }
        
        // --- Theme & Model UI ---
        function toggleTheme() { theme = theme === 'light' ? 'dark' : 'light'; setTheme(theme); }
        function setTheme(t) { document.body.setAttribute('data-theme', t); localStorage.setItem('hkdse_theme_v4', t); }
        
        function renderModelSelector() {
            modelSelectorBtn.textContent = AVAILABLE_MODELS[currentModel];
            modelSelectorMenu.innerHTML = Object.entries(AVAILABLE_MODELS).map(([id, name]) =>
                `<li class="model-item ${id === currentModel ? 'selected' : ''}" onclick="selectModel('${id}')">${name}</li>`
            ).join('');
        }
        
        function selectModel(id) {
            currentModel = id;
            localStorage.setItem('hkdse_model_v4', id);
            if(activeChatId) {
                chatHistories[activeChatId].model = id;
                saveHistory();
            }
            renderModelSelector();
            modelSelectorMenu.classList.remove('active');
        }

        // --- Chat Logic ---
        function createNewChat() {
            Object.keys(chatHistories).forEach(id => { if (!chatHistories[id].messages || chatHistories[id].messages.length === 0) delete chatHistories[id]; });
            const id = Date.now().toString();
            chatHistories[id] = { title: 'New Topic', messages: [], model: currentModel };
            activeChatId = id;
            localStorage.setItem('hkdse_active_id_v4', id);
            saveHistory();
            renderHistoryList();
            renderChatUI();
            getEl('sidebar').classList.remove('open');
        }

        function loadChat(id) {
            activeChatId = id;
            localStorage.setItem('hkdse_active_id_v4', id);
            currentModel = chatHistories[id].model || currentModel;
            localStorage.setItem('hkdse_model_v4', currentModel);
            renderModelSelector();
            renderChatUI();
            getEl('sidebar').classList.remove('open');
            renderHistoryList();
        }

        function renderHistoryList() {
            historyList.innerHTML = Object.keys(chatHistories).sort().reverse().map(id => `
                <li class="history-item ${id === activeChatId ? 'active' : ''}" onclick="loadChat('${id}')">
                    <span id="title-${id}" style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:160px;">${chatHistories[id].title}</span>
                    <div class="actions">
                        <button class="icon-btn" onclick="renameChatUI(event, '${id}')">âœŽ</button>
                        <button class="icon-btn" onclick="deleteChat(event, '${id}')">Ã—</button>
                    </div>
                </li>
            `).join('');
        }

        function renameChatUI(e, id) { e.stopPropagation(); const newTitle = prompt("Rename chat:", chatHistories[id].title); if(newTitle) { chatHistories[id].title = newTitle; saveHistory(); renderHistoryList(); } }
        function deleteChat(e, id) { e.stopPropagation(); if(confirm('Delete this chat?')) { delete chatHistories[id]; saveHistory(); if(activeChatId === id) createNewChat(); renderHistoryList(); } }

        function renderChatUI() {
            const messages = chatHistories[activeChatId]?.messages || [];
            if (messages.length === 0) {
                chatContainer.innerHTML = renderMessage('ai', `Hello! ${userProfile.name}. ðŸ‘‹<br>æº–å‚™å¥½æº«ç¿’é‚Šä¸€ç§‘æœªï¼Ÿ`, -1);
            } else {
                chatContainer.innerHTML = messages.map((msg, index) => renderMessage(msg.role, msg.content, index)).join('');
            }
            scrollToBottom();
        }

        function appendMessageToUI(html) { chatContainer.insertAdjacentHTML('beforeend', html); scrollToBottom(); }
        function scrollToBottom() { chatContainer.scrollTop = chatContainer.scrollHeight; }

        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text || sendBtn.disabled) return;
            userInput.value = ''; userInput.style.height = 'auto';
            
            const currentChat = chatHistories[activeChatId];
            const msgIndex = currentChat.messages.length;
            appendMessageToUI(renderMessage('user', text, msgIndex));
            
            currentChat.messages.push({ role: 'user', content: text });
            saveHistory();
            await processAIResponse(currentChat);
        }

        function editMessage(index) {
            const currentChat = chatHistories[activeChatId];
            userInput.value = currentChat.messages[index].content;
            userInput.focus();
            currentChat.messages = currentChat.messages.slice(0, index);
            saveHistory();
            renderChatUI();
        }

        async function processAIResponse(currentChat) {
            sendBtn.disabled = true;
            appendMessageToUI(renderMessage('ai', 'Thinking...', -1));
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: currentModel, messages: currentChat.messages, userProfile: userProfile })
                });
                const data = await response.json();
                chatContainer.lastChild.remove(); // Remove "Thinking..."
                
                if (data.status === 'success') {
                    currentChat.messages.push({ role: 'assistant', content: data.content });
                    appendMessageToUI(renderMessage('ai', data.content, currentChat.messages.length - 1));
                    saveHistory();
                    updateTitleInBackground(currentChat);
                } else {
                    appendMessageToUI(renderMessage('ai', `âš ï¸ Error: ${data.message}`, -1));
                }
            } catch (err) {
                chatContainer.lastChild.remove();
                appendMessageToUI(renderMessage('ai', `âš ï¸ Network Error: ${err.message}`, -1));
            }
            sendBtn.disabled = false;
        }

        async function updateTitleInBackground(chat) {
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: chat.model, messages: chat.messages, isTitleGeneration: true })
                });
                const data = await response.json();
                if(data.status === 'success' && data.content) {
                    let cleanTitle = data.content.replace(/["\n]/g, '').trim();
                    if(cleanTitle.length > 30) cleanTitle = cleanTitle.substring(0, 30) + "...";
                    chat.title = cleanTitle;
                    saveHistory();
                    renderHistoryList();
                }
            } catch(e) { console.error("Title auto-gen failed:", e); }
        }

        function saveHistory() { localStorage.setItem('hkdse_chats_v4', JSON.stringify(chatHistories)); }

        // --- Profile Logic ---
        function openProfile() { getEl('p-name').value = userProfile.name; getEl('p-form').value = userProfile.form; getEl('p-about').value = userProfile.about; getEl('p-preview').src = userProfile.avatar; getEl('profile-modal').classList.add('active'); }
        function closeProfile() { getEl('profile-modal').classList.remove('active'); }
        function handleImageUpload(input) { if (input.files && input.files[0]) { const reader = new FileReader(); reader.onload = e => getEl('p-preview').src = e.target.result; reader.readAsDataURL(input.files[0]); } }
        function saveProfile() { userProfile.name = getEl('p-name').value; userProfile.form = getEl('p-form').value; userProfile.about = getEl('p-about').value; userProfile.avatar = getEl('p-preview').src; localStorage.setItem('hkdse_profile_v4', JSON.stringify(userProfile)); loadProfileUI(); closeProfile(); if(activeChatId) renderChatUI(); }
        function loadProfileUI() { getEl('profile-name-sidebar').innerText = userProfile.name; getEl('profile-form-sidebar').innerText = userProfile.form; getEl('profile-img-sidebar').src = userProfile.avatar; }

        // --- Mobile & Misc ---
        function toggleSidebar() { getEl('sidebar').classList.toggle('open'); }
        document.addEventListener('click', e => { const sidebar = getEl('sidebar'); const menuBtn = document.querySelector('.menu-btn'); if (window.innerWidth <= 768 && sidebar.classList.contains('open') && !sidebar.contains(e.target) && !menuBtn.contains(e.target)) { sidebar.classList.remove('open'); } });
    </script>
</body>
</html>
