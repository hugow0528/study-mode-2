<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Study Guide | HKDSE</title>
    <!-- Â≠óÈ´îËàá Markdown ÊîØÊè¥ -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+HK:wght@300;400;500;700&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>

    <style>
        :root {
            /* Wabi-sabi Dark Mode */
            --bg-main: #1C1C1E;      /* Ê∑±ÁÇ≠ÁÅ∞ */
            --bg-sidebar: #151517;   /* Êõ¥Ê∑±ÁöÑÁÅ∞ */
            --bg-card: #2C2C2E;      /* Âç°ÁâáÁÅ∞ */
            --text-primary: #E5E5E7; /* Á±≥ÁôΩ */
            --text-secondary: #8E8E93; /* Ê∑∫ÁÅ∞ */
            --accent: #0A84FF;       /* iOS Blue */
            --accent-glow: rgba(10, 132, 255, 0.15);
            --border: #38383A;
            --radius: 14px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Noto Sans HK', sans-serif; background: var(--bg-main); color: var(--text-primary); height: 100dvh; display: flex; overflow: hidden; }
        
        /* Sidebar */
        #sidebar { width: 260px; background: var(--bg-sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; transition: transform 0.3s ease; z-index: 100; flex-shrink: 0; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border); }
        .new-chat-btn { width: 100%; padding: 12px; background: var(--accent); color: white; border: none; border-radius: var(--radius); font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: opacity 0.2s; }
        .new-chat-btn:active { opacity: 0.8; }
        
        #history-list { list-style: none; padding: 10px; margin: 0; overflow-y: auto; flex: 1; }
        .history-item { padding: 12px; margin-bottom: 4px; border-radius: 8px; cursor: pointer; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 0.9rem; transition: background 0.2s; display: flex; justify-content: space-between; group; }
        .history-item:hover, .history-item.active { background: var(--bg-card); color: var(--text-primary); }
        .history-item .delete-btn { visibility: hidden; background: none; border: none; color: #ff453a; cursor: pointer; padding: 0 4px; }
        .history-item:hover .delete-btn { visibility: visible; }

        .sidebar-footer { padding: 15px; border-top: 1px solid var(--border); display: flex; gap: 10px; align-items: center; cursor: pointer; }
        .avatar { width: 32px; height: 32px; border-radius: 50%; background: var(--bg-card); object-fit: cover; }
        
        /* Main Chat Area */
        #main { flex: 1; display: flex; flex-direction: column; position: relative; width: 100%; }
        
        .top-bar { padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border); background: rgba(28, 28, 30, 0.85); backdrop-filter: blur(10px); z-index: 10; }
        .model-selector { background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border); padding: 8px 12px; border-radius: 8px; font-size: 0.9rem; outline: none; max-width: 200px; }
        
        #chat-container { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 100px; scroll-behavior: smooth; }
        
        .message-row { display: flex; margin-bottom: 24px; animation: fadeIn 0.3s ease; }
        .message-row.user { justify-content: flex-end; }
        .message-bubble { max-width: 85%; padding: 12px 18px; border-radius: 18px; line-height: 1.6; font-size: 1rem; position: relative; word-wrap: break-word; }
        
        .user .message-bubble { background: var(--accent); color: white; border-bottom-right-radius: 4px; }
        .ai .message-bubble { background: var(--bg-card); color: var(--text-primary); border-bottom-left-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        
        /* Markdown Styles */
        .message-bubble code { font-family: 'JetBrains Mono', monospace; font-size: 0.9em; background: rgba(0,0,0,0.3); padding: 2px 4px; border-radius: 4px; }
        .message-bubble pre { background: #111; padding: 15px; border-radius: 10px; overflow-x: auto; margin: 10px 0; border: 1px solid var(--border); }
        .message-bubble p { margin: 0 0 10px 0; }
        .message-bubble p:last-child { margin: 0; }

        /* Input Area */
        .input-area { position: absolute; bottom: 0; left: 0; right: 0; padding: 20px; background: linear-gradient(to top, var(--bg-main) 80%, transparent); display: flex; justify-content: center; }
        .input-wrapper { width: 100%; max-width: 800px; background: var(--bg-card); border-radius: 24px; padding: 10px 16px; display: flex; align-items: flex-end; gap: 10px; border: 1px solid var(--border); box-shadow: 0 4px 20px rgba(0,0,0,0.2); transition: border-color 0.2s; }
        .input-wrapper:focus-within { border-color: var(--accent); }
        
        textarea { flex: 1; background: transparent; border: none; color: var(--text-primary); resize: none; max-height: 150px; padding: 10px 0; font-size: 1rem; font-family: inherit; outline: none; line-height: 1.5; }
        
        .send-btn { background: var(--accent); color: white; border: none; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; transition: transform 0.1s; margin-bottom: 4px; }
        .send-btn:hover { opacity: 0.9; }
        .send-btn:active { transform: scale(0.95); }
        .send-btn:disabled { background: var(--border); cursor: not-allowed; }

        /* Mobile Menu */
        .menu-btn { display: none; background: none; border: none; color: var(--text-primary); font-size: 1.5rem; cursor: pointer; }
        
        /* Modal */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 1000; }
        .modal.active { opacity: 1; pointer-events: all; }
        .modal-content { background: var(--bg-sidebar); padding: 30px; border-radius: 20px; width: 90%; max-width: 400px; border: 1px solid var(--border); }
        .modal h2 { margin-top: 0; color: var(--accent); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 0.9rem; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; background: var(--bg-main); border: 1px solid var(--border); color: var(--text-primary); padding: 10px; border-radius: 8px; font-family: inherit; }
        .save-btn { width: 100%; padding: 12px; background: var(--accent); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; }

        @media (max-width: 768px) {
            #sidebar { position: fixed; left: -260px; height: 100%; }
            #sidebar.open { transform: translateX(260px); }
            .menu-btn { display: block; }
            .message-bubble { max-width: 90%; }
        }
    </style>
</head>
<body>

    <!-- Sidebar -->
    <aside id="sidebar">
        <div class="sidebar-header">
            <button class="new-chat-btn" onclick="createNewChat()">
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"></path></svg>
                New Chat
            </button>
        </div>
        <ul id="history-list">
            <!-- History Items go here -->
        </ul>
        <div class="sidebar-footer" onclick="openProfile()">
            <img src="" id="profile-img" class="avatar" alt="User">
            <div style="flex:1; overflow:hidden;">
                <div id="profile-name" style="font-weight:600; font-size:0.95rem;">Student</div>
                <div id="profile-form" style="font-size:0.8rem; color:var(--text-secondary);">Form 4</div>
            </div>
            <svg width="20" height="20" fill="var(--text-secondary)" viewBox="0 0 20 20"><path d="M10 8.33c.92 0 1.67.75 1.67 1.67s-.75 1.67-1.67 1.67S8.33 10.92 8.33 10 9.08 8.33 10 8.33zM18.34 11.1v-2.2l-2.06-.59a6.03 6.03 0 00-.73-1.35l.93-1.92-1.55-1.55-.1.1-1.82.98a6.01 6.01 0 00-1.35-.73L11.1 1.66h-2.2l-.59 2.06a6.03 6.03 0 00-1.35.73l-1.92-.93-1.55 1.55.98 1.82c-.27.42-.46.88-.73 1.35L1.66 8.9v2.2l2.06.59c.27.47.46.93.73 1.35l-.93 1.92 1.55 1.55.1-.1 1.82-.98c.42.27.88.46 1.35.73l.59 2.06h2.2l-.59-2.06c.47-.27.93-.46 1.35-.73l1.92.93 1.55-1.55-.98-1.82c.27-.42.46-.88.73-1.35l2.06-.59zM10 13.33a3.33 3.33 0 110-6.66 3.33 3.33 0 010 6.66z"/></svg>
        </div>
    </aside>

    <!-- Main Content -->
    <main id="main">
        <div class="top-bar">
            <button class="menu-btn" onclick="toggleSidebar()">‚ò∞</button>
            <div style="font-weight:600; letter-spacing:1px;">STUDY MODE</div>
            <select id="model-select" class="model-selector">
                <optgroup label="Google Gemini (Reasoning)">
                    <option value="gemini-3-pro-preview">‚ú® Gemini 3 Pro (Preview)</option>
                    <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
                </optgroup>
                <optgroup label="Cerebras (Fastest)">
                    <option value="llama-3.3-70b">Llama 3.3 70B</option>
                    <option value="llama3.1-8b">Llama 3.1 8B</option>
                    <option value="gpt-oss-120b">GPT OSS 120B</option>
                    <option value="qwen-3-32b">Qwen 3 32B</option>
                    <option value="qwen-3-235b-a22b-instruct-2507">Qwen 3 235B</option>
                    <option value="zai-glm-4.6">Z.ai GLM 4.6</option>
                </optgroup>
            </select>
        </div>

        <div id="chat-container">
            <!-- Chat Messages -->
            <div class="message-row ai">
                <div class="message-bubble">
                    Hello! Êàë‰øÇ‰Ω†ÂòÖ Study Buddy„ÄÇüëã <br>
                    ‰ªäÊó•ÊÉ≥Ê∫´Âí©ÁßëÔºüÂÆö‰øÇÊúâÂò¢ÊÉ≥ÂïèÔºü(Support Gemini 3 & Cerebras)
                </div>
            </div>
        </div>

        <div class="input-area">
            <div class="input-wrapper">
                <textarea id="user-input" placeholder="Type a message..." rows="1"></textarea>
                <button id="send-btn" class="send-btn" onclick="sendMessage()">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"></path></svg>
                </button>
            </div>
        </div>
    </main>

    <!-- Profile Modal -->
    <div id="profile-modal" class="modal">
        <div class="modal-content">
            <h2>Profile Settings</h2>
            <div class="form-group">
                <label>Name</label>
                <input type="text" id="p-name" placeholder="Your Name">
            </div>
            <div class="form-group">
                <label>Form</label>
                <select id="p-form">
                    <option>S1</option><option>S2</option><option>S3</option>
                    <option>S4</option><option>S5</option><option>S6</option>
                </select>
            </div>
            <div class="form-group">
                <label>About Me (for personalized teaching)</label>
                <textarea id="p-about" rows="3" placeholder="Weak in Math? Love History?"></textarea>
            </div>
            <button class="save-btn" onclick="saveProfile()">Save Profile</button>
        </div>
    </div>

    <script>
        // State Management
        let chatHistories = JSON.parse(localStorage.getItem('hkdse_chats')) || {};
        let activeChatId = null;
        let userProfile = JSON.parse(localStorage.getItem('hkdse_profile')) || { name: 'Student', form: 'S5', about: '' };

        // DOM Elements
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const historyList = document.getElementById('history-list');
        const modelSelect = document.getElementById('model-select');

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            loadProfileUI();
            renderHistoryList();
            
            // Auto-resize textarea
            userInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
                if(this.value === '') this.style.height = 'auto';
            });
            
            // Enter key to send
            userInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Load last chat or create new
            const lastId = localStorage.getItem('hkdse_active_id');
            if(lastId && chatHistories[lastId]) {
                loadChat(lastId);
            } else {
                createNewChat();
            }
        });

        // Functions
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        function createNewChat() {
            const id = Date.now().toString();
            chatHistories[id] = { title: 'New Chat', messages: [], model: modelSelect.value };
            activeChatId = id;
            localStorage.setItem('hkdse_active_id', id);
            saveHistory();
            renderHistoryList();
            renderChatUI();
            document.getElementById('sidebar').classList.remove('open'); // Close on mobile
        }

        function loadChat(id) {
            activeChatId = id;
            localStorage.setItem('hkdse_active_id', id);
            
            // Restore model used for this chat
            if(chatHistories[id].model) {
                modelSelect.value = chatHistories[id].model;
            }
            
            renderChatUI();
            document.getElementById('sidebar').classList.remove('open');
        }

        function deleteChat(e, id) {
            e.stopPropagation();
            if(confirm('Delete this chat?')) {
                delete chatHistories[id];
                saveHistory();
                renderHistoryList();
                if(activeChatId === id) createNewChat();
            }
        }

        function renderHistoryList() {
            historyList.innerHTML = Object.keys(chatHistories).sort().reverse().map(id => `
                <li class="history-item ${id === activeChatId ? 'active' : ''}" onclick="loadChat('${id}')">
                    <span>${chatHistories[id].title}</span>
                    <button class="delete-btn" onclick="deleteChat(event, '${id}')">√ó</button>
                </li>
            `).join('');
        }

        function renderChatUI() {
            chatContainer.innerHTML = '';
            const messages = chatHistories[activeChatId].messages;
            
            if (messages.length === 0) {
                chatContainer.innerHTML = `<div class="message-row ai"><div class="message-bubble">Hello! ${userProfile.name}, Ê∫ñÂÇôÂ•ΩÊ∫´ÁøíÊú™ÔºüÊàëÂÄëÂèØ‰ª•ÈñãÂßã‰∫ÜÔºÅ(Current: ${modelSelect.options[modelSelect.selectedIndex].text})</div></div>`;
            } else {
                messages.forEach(msg => appendMessageUI(msg.role, msg.content));
            }
            scrollToBottom();
        }

        function appendMessageUI(role, text) {
            const div = document.createElement('div');
            div.className = `message-row ${role === 'user' ? 'user' : 'ai'}`;
            
            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            
            if (role === 'ai') {
                // Parse Markdown safely
                bubble.innerHTML = DOMPurify.sanitize(marked.parse(text));
            } else {
                bubble.innerText = text;
            }
            
            div.appendChild(bubble);
            chatContainer.appendChild(div);
            scrollToBottom();
        }

        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text) return;

            // UI Update
            userInput.value = '';
            userInput.style.height = 'auto';
            appendMessageUI('user', text);
            
            // Save User Message
            const currentChat = chatHistories[activeChatId];
            currentChat.messages.push({ role: 'user', content: text });
            currentChat.model = modelSelect.value; // Update model preference
            
            // Loading State
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message-row ai';
            loadingDiv.innerHTML = `<div class="message-bubble" style="color:var(--text-secondary)">Thinking (${modelSelect.value})...</div>`;
            chatContainer.appendChild(loadingDiv);
            scrollToBottom();
            sendBtn.disabled = true;

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: modelSelect.value,
                        messages: currentChat.messages,
                        userProfile: userProfile
                    })
                });

                const data = await response.json();
                chatContainer.removeChild(loadingDiv);

                if (data.status === 'success') {
                    appendMessageUI('ai', data.content);
                    currentChat.messages.push({ role: 'assistant', content: data.content });
                    
                    // Generate Title if it's the first message
                    if (currentChat.messages.length <= 2) {
                        generateTitle(text);
                    }
                } else {
                    appendMessageUI('ai', `‚ö†Ô∏è Error: ${data.message}\n${data.details || ''}`);
                }

            } catch (err) {
                chatContainer.removeChild(loadingDiv);
                appendMessageUI('ai', `‚ö†Ô∏è Network Error: ${err.message}`);
            }

            saveHistory();
            sendBtn.disabled = false;
        }

        async function generateTitle(firstMsg) {
            // Simple title generation without calling API to save quota, or implement simple logic
            const title = firstMsg.substring(0, 20) + (firstMsg.length > 20 ? '...' : '');
            chatHistories[activeChatId].title = title;
            saveHistory();
            renderHistoryList();
        }

        // Profile Functions
        function openProfile() {
            document.getElementById('p-name').value = userProfile.name;
            document.getElementById('p-form').value = userProfile.form;
            document.getElementById('p-about').value = userProfile.about;
            document.getElementById('profile-modal').classList.add('active');
        }

        function saveProfile() {
            userProfile.name = document.getElementById('p-name').value;
            userProfile.form = document.getElementById('p-form').value;
            userProfile.about = document.getElementById('p-about').value;
            localStorage.setItem('hkdse_profile', JSON.stringify(userProfile));
            loadProfileUI();
            document.getElementById('profile-modal').classList.remove('active');
        }

        function loadProfileUI() {
            document.getElementById('profile-name').innerText = userProfile.name;
            document.getElementById('profile-form').innerText = userProfile.form;
            document.getElementById('profile-img').src = `https://api.dicebear.com/7.x/initials/svg?seed=${userProfile.name}`;
        }

        function saveHistory() {
            localStorage.setItem('hkdse_chats', JSON.stringify(chatHistories));
        }

        // Close modal on outside click
        document.getElementById('profile-modal').addEventListener('click', (e) => {
            if (e.target.id === 'profile-modal') e.target.classList.remove('active');
        });
    </script>
</body>
</html>
