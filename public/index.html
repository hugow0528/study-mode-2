<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Learning Guide | HKDSE</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <!-- MARKDOWN LIBRARIES -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@2.3.6/dist/purify.min.js"></script>

    <style>
        :root { --sidebar-width: 280px; }
        body[data-theme="dark"] { --bg-color: #121418; --sidebar-color: #1a1d24; --chat-bg-color: #16181d; --secondary-color: #2a3b4f; --accent-color: #4a90e2; --text-color: #e0e0e0; --subtle-text-color: #8899a6; --border-color: #2a2d34; --input-bg-color: #2a2d34; --hover-bg-color: #252830; --ai-message-bg: #2a2d34; --code-bg-color: #101216; --modal-overlay-color: rgba(0, 0, 0, 0.7); }
        body[data-theme="light"] { --bg-color: #f0f2f5; --sidebar-color: #ffffff; --chat-bg-color: #f7f8fa; --secondary-color: #e4e6eb; --accent-color: #1877f2; --text-color: #1c1e21; --subtle-text-color: #65676b; --border-color: #ced0d4; --input-bg-color: #e4e6eb; --hover-bg-color: #f0f2f5; --ai-message-bg: #e4e6eb; --code-bg-color: #eef0f2; --modal-overlay-color: rgba(0, 0, 0, 0.6); }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; overflow: hidden; }
        body { font-family: 'Noto Sans', 'Segoe UI', 'Roboto', sans-serif; background-color: var(--bg-color); color: var(--text-color); transition: background-color 0.3s, color 0.3s; }
        #app-container { display: flex; height: 100dvh; }
        #sidebar { width: var(--sidebar-width); background-color: var(--sidebar-color); display: flex; flex-direction: column; border-right: 1px solid var(--border-color); transition: transform 0.3s ease, background-color 0.3s; flex-shrink: 0; }
        .sidebar-header { padding: 1rem 1.25rem; border-bottom: 1px solid var(--border-color); }
        #new-chat-btn { width: 100%; padding: 0.75rem; background-color: transparent; border: 1px solid var(--accent-color); color: var(--accent-color); border-radius: 8px; font-size: 0.9rem; font-weight: 500; cursor: pointer; transition: background-color 0.2s, color 0.2s; }
        #new-chat-btn:hover { background-color: var(--accent-color); color: white; }
        #history-list { flex-grow: 1; list-style: none; overflow-y: auto; padding: 0.5rem; }
        .history-item { display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 1rem; margin: 0.25rem; border-radius: 6px; cursor: pointer; color: var(--subtle-text-color); transition: background-color 0.2s, color 0.2s; }
        .history-item-title { flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .history-item-actions { display: flex; opacity: 0; transition: opacity 0.2s; }
        .history-item:hover .history-item-actions { opacity: 1; }
        .history-item-actions button { background: none; border: none; cursor: pointer; padding: 4px; }
        .history-item-actions svg { width: 16px; height: 16px; fill: var(--subtle-text-color); }
        .history-item-actions button:hover svg { fill: var(--text-color); }
        .history-item:hover { background-color: var(--hover-bg-color); color: var(--text-color); }
        .history-item.active { background-color: var(--secondary-color); color: var(--text-color); font-weight: 500; }
        .history-title-input { width: 100%; background: var(--input-bg-color); border: 1px solid var(--accent-color); color: var(--text-color); padding: 4px 6px; border-radius: 4px; }
        .sidebar-footer { padding: 1rem 1.25rem; border-top: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; gap: 0.5rem; }
        #user-profile { display: flex; align-items: center; gap: 0.75rem; cursor: pointer; background-color: transparent; border: none; padding: 0.25rem; border-radius: 6px; flex-grow: 1; text-align: left; transition: background-color .2s; min-width: 0; }
        #user-profile:hover { background-color: var(--hover-bg-color); }
        .profile-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; flex-shrink: 0; background-color: var(--secondary-color); }
        .profile-name { color: var(--text-color); font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #settings-btn { background: none; border: none; cursor: pointer; padding: 0.5rem; flex-shrink: 0; }
        #settings-btn svg { width: 20px; height: 20px; fill: var(--subtle-text-color); transition: fill 0.2s; }
        #settings-btn:hover svg { fill: var(--text-color); }
        #chat-container { flex-grow: 1; display: flex; flex-direction: column; height: 100dvh; background-color: var(--chat-bg-color); }
        .chat-header { display: none; padding: 1rem; border-bottom: 1px solid var(--border-color); }
        #menu-btn { background: none; border: none; cursor: pointer; }
        #menu-btn svg { width: 24px; height: 24px; fill: var(--text-color); }
        #chat-history { flex-grow: 1; overflow-y: auto; padding: 1.5rem; display: flex; flex-direction: column; gap: 1.5rem; }
        .message-wrapper { display: flex; align-items: flex-end; gap: 10px; max-width: 85%; animation: fadeIn 0.3s ease forwards; opacity: 0; transform: translateY(10px); position: relative; }
        .message-wrapper:hover .message-actions { opacity: 1; }
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }
        .chat-avatar { width: 32px; height: 32px; border-radius: 50%; flex-shrink: 0; background-color: var(--secondary-color); }
        .message-content { display: flex; flex-direction: column; width: 100%; }
        .message { padding: 0.75rem 1.25rem; border-radius: 20px; line-height: 1.6; word-wrap: break-word; }
        .user-message-wrapper { align-self: flex-end; flex-direction: row-reverse; }
        .user-message-wrapper .message { background-image: linear-gradient(to right, #4a90e2, #2a6db7); color: #fff; border-bottom-right-radius: 6px; }
        .message-actions { position: absolute; bottom: -20px; display: flex; gap: 4px; background: var(--sidebar-color); border: 1px solid var(--border-color); border-radius: 16px; padding: 2px 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); opacity: 0; transition: opacity .2s, bottom .2s; }
        .user-message-wrapper .message-actions { right: 42px; }
        .message-actions button { background: none; border: none; cursor: pointer; padding: 4px; }
        .message-actions svg { width: 14px; height: 14px; fill: var(--subtle-text-color); }
        .message-actions button:hover svg { fill: var(--text-color); }
        .edit-prompt-area { display: flex; flex-direction: column; gap: 8px; }
        .edit-prompt-area textarea { background: var(--input-bg-color); color: var(--text-color); border: 1px solid var(--accent-color); border-radius: 8px; padding: 8px; resize: vertical; min-height: 60px; font-family: inherit; font-size: 1rem; }
        .edit-prompt-actions { display: flex; justify-content: flex-end; gap: 8px; }
        .edit-prompt-actions button { padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; font-weight: 500; }
        .edit-prompt-save { background-color: var(--accent-color); color: white; }
        .edit-prompt-cancel { background-color: var(--secondary-color); color: var(--text-color); }
        .ai-message-wrapper { align-self: flex-start; }
        .ai-message-wrapper .message { background-color: var(--ai-message-bg); border-bottom-left-radius: 6px; }
        .ai-message-wrapper .message > *:first-child { margin-top: 0; }
        .ai-message-wrapper .message > *:last-child { margin-bottom: 0; }
        .ai-message-wrapper .message p, .ai-message-wrapper .message ul, .ai-message-wrapper .message ol { margin-bottom: 0.75em; }
        .ai-message-wrapper .message ul, .ai-message-wrapper .message ol { padding-left: 1.5em; }
        .ai-message-wrapper .message strong { font-weight: 600; color: var(--text-color); }
        .ai-message-wrapper .message pre { white-space: pre-wrap; word-wrap: break-word; background-color: var(--code-bg-color); color: var(--text-color); padding: 1rem; border-radius: 8px; margin: 1em 0; font-family: 'Courier New', Courier, monospace; font-size: 0.9rem; border: 1px solid var(--border-color); }
        .ai-message-wrapper .message code { background-color: var(--code-bg-color); padding: 0.2em 0.4em; margin: 0; font-size: 85%; border-radius: 3px; }
        .ai-message-wrapper .message pre code { background-color: transparent; padding: 0; margin: 0; font-size: inherit; border-radius: 0; }
        #input-area { flex-shrink: 0; padding: 1rem 1.5rem; border-top: 1px solid var(--border-color); background-color: var(--chat-bg-color); display: flex; align-items: flex-end; gap: 0.75rem; }
        #input-area textarea { flex-grow: 1; background-color: var(--input-bg-color); border: 1px solid var(--border-color); color: var(--text-color); border-radius: 24px; padding: 0.75rem 1.25rem; font-family: inherit; font-size: 1rem; resize: none; max-height: 150px; line-height: 1.5; transition: border-color 0.2s ease; }
        #input-area textarea:focus { outline: none; border-color: var(--accent-color); }
        #input-area button { background-color: var(--accent-color); border: none; color: white; border-radius: 50%; cursor: pointer; transition: background-color 0.2s ease; width: 48px; height: 48px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
        #input-area button:hover { opacity: 0.8; }
        #input-area button svg { width: 24px; height: 24px; fill: white; }
        .modal { position: fixed; inset: 0; background-color: var(--modal-overlay-color); display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; z-index: 1000; }
        .modal.visible { opacity: 1; visibility: visible; }
        .modal-content { background-color: var(--sidebar-color); padding: 2rem; border-radius: 12px; width: 90%; max-width: 450px; border: 1px solid var(--border-color); transform: scale(0.95); transition: transform 0.3s; }
        .modal.visible .modal-content { transform: scale(1); }
        .modal-content h2 { margin-bottom: 1.5rem; text-align: center; font-weight: 500; }
        .setting-group { margin-bottom: 1.25rem; }
        .setting-group label { display: block; margin-bottom: 0.5rem; color: var(--subtle-text-color); font-size: 0.9rem; }
        .setting-group select, .setting-group input, .setting-group textarea { width: 100%; background-color: var(--input-bg-color); border: 1px solid var(--border-color); color: var(--text-color); padding: 0.75rem; border-radius: 8px; font-size: 1rem; }
        .setting-group textarea { resize: vertical; min-height: 80px; }
        .modal-actions { text-align: right; margin-top: 2rem; }
        .modal-actions button { padding: 0.75rem 1.5rem; background-color: var(--accent-color); border: none; color: white; border-radius: 8px; cursor: pointer; font-weight: 500; }
        #avatar-upload-label { display: block; text-align: center; padding: 0.75rem; border: 2px dashed var(--border-color); border-radius: 8px; cursor: pointer; margin-top: 0.5rem; }
        #avatar-upload-label:hover { border-color: var(--accent-color); }
        #user-avatar-upload { display: none; }
        #avatar-preview { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; display: block; margin: 1rem auto; }
        .theme-toggle { display: flex; justify-content: space-between; align-items: center; }
        #theme-toggle-btn { background: var(--input-bg-color); border: 1px solid var(--border-color); border-radius: 20px; padding: 4px; cursor: pointer; display: flex; }
        #theme-toggle-btn svg { width: 20px; height: 20px; fill: var(--subtle-text-color); }
        #theme-toggle-btn .icon-dark, body[data-theme="light"] #theme-toggle-btn .icon-light { display: none; }
        body[data-theme="dark"] #theme-toggle-btn .icon-dark, body[data-theme="light"] #theme-toggle-btn .icon-light { display: block; }
        #welcome-screen { text-align: center; line-height: 1.7; }
        #welcome-screen p { color: var(--subtle-text-color); margin-bottom: 2rem; }
        #welcome-screen button { width: 100%; font-size: 1rem; font-weight: 600; }
        @media (max-width: 768px) {
            #sidebar { position: absolute; left: 0; top: 0; height: 100%; transform: translateX(-100%); z-index: 100; }
            #sidebar.open { transform: translateX(0); box-shadow: 10px 0 30px rgba(0,0,0,0.5); }
            .chat-header { display: flex; }
            #app-container.menu-open #chat-container { filter: blur(4px); pointer-events: none; }
            .message-wrapper:hover .message-actions { opacity: 0; }
            .message-wrapper .message-actions { opacity: 1; }
        }
    </style>
</head>
<body data-theme="dark">
    <div id="app-container">
        <aside id="sidebar">
            <div class="sidebar-header"><button id="new-chat-btn">ï¼‹ New Chat</button></div>
            <ul id="history-list"></ul>
            <div class="sidebar-footer">
                <button id="user-profile"><img id="profile-avatar" src="" alt="User Avatar" class="profile-avatar"><span id="profile-name" class="profile-name"></span></button>
                <button id="settings-btn" title="Settings"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M10 8.33c.92 0 1.67.75 1.67 1.67s-.75 1.67-1.67 1.67S8.33 10.92 8.33 10 9.08 8.33 10 8.33zM18.34 11.1v-2.2l-2.06-.59a6.03 6.03 0 00-.73-1.35l.93-1.92-1.55-1.55-.1.1-1.82.98a6.01 6.01 0 00-1.35-.73L11.1 1.66h-2.2l-.59 2.06a6.03 6.03 0 00-1.35.73l-1.92-.93-1.55 1.55.98 1.82c-.27.42-.46.88-.73 1.35L1.66 8.9v2.2l2.06.59c.27.47.46.93.73 1.35l-.93 1.92 1.55 1.55.1-.1 1.82-.98c.42.27.88.46 1.35.73l.59 2.06h2.2l-.59-2.06c.47-.27.93-.46 1.35-.73l1.92.93 1.55-1.55-.98-1.82c.27-.42.46-.88.73-1.35l2.06-.59zM10 13.33a3.33 3.33 0 110-6.66 3.33 3.33 0 010 6.66z"/></svg></button>
            </div>
        </aside>
        <main id="chat-container">
            <div class="chat-header"><button id="menu-btn" title="Open Menu"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></button></div>
            <div id="chat-history"></div>
            <div id="input-area">
                <textarea id="user-input" placeholder="Ask me anything..." rows="1"></textarea>
                <button id="send-btn" title="Send Message"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
            </div>
        </main>
    </div>
    
    <!-- Modals -->
    <div id="welcome-modal" class="modal">
        <div id="welcome-screen" class="modal-content">
            <h2>Welcome to your AI Learning Guide!</h2>
            <p>I'm here to help you study, not to do your homework for you. Let's learn together!<br>To get started, please tell me a little about yourself.</p>
            <div class="modal-actions" style="text-align: center;"><button id="welcome-lets-go-btn">Let's Go</button></div>
        </div>
    </div>
    
    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <h2>Settings</h2>
            <div class="setting-group">
                <label for="model-select">AI Model</label>
                <select id="model-select">
                    <option value="gemini-2.5-pro">Gemini 2.5 Pro (Recommended)</option>
                    <option value="gemini-2.5-flash-lite">Gemini 2.5 Flash Lite</option>
                    <option value="deepseek-chat">DeepSeek Chat</option>
                    <option value="grok-3">Grok-3</option>
                    <option value="llama-3.3-70b">Llama 3.3 70B</option>
                </select>
            </div>
            <div class="setting-group theme-toggle"><label>Color Mode</label><button id="theme-toggle-btn" title="Toggle Theme"><svg class="icon-light" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.64 5.64c-.39-.39-1.02-.39-1.41 0-.39.39-.39 1.02 0 1.41l1.06 1.06c.39.39 1.02.39 1.41 0s.39-1.02 0-1.41L5.64 5.64zm12.73 12.73c-.39-.39-1.02-.39-1.41 0-.39.39-.39 1.02 0 1.41l1.06 1.06c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41l-1.06-1.06zm1.06-12.73c.39-.39.39-1.02 0-1.41-.39-.39-1.02-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.02 0 1.41s1.02.39 1.41 0l1.06-1.06zM7.05 18.36c.39-.39.39-1.02 0-1.41-.39-.39-1.02-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.02 0 1.41s1.02.39 1.41 0l1.06-1.06z"/></svg><svg class="icon-dark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-4.97-4.03-9-9-9zM12 19c-3.86 0-7-3.14-7-7s3.14-7 7-7 7 3.14 7 7-3.14 7-7 7z"/></svg></button></div>
            <div class="modal-actions"><button id="close-settings-btn">Done</button></div>
        </div>
    </div>
    
    <div id="profile-modal" class="modal">
        <div class="modal-content">
            <h2>Your Profile</h2>
            <img id="avatar-preview" src="" alt="Avatar Preview">
            <div class="setting-group"><label for="user-avatar-upload">Upload Avatar</label><input type="file" id="user-avatar-upload" accept="image/*"><label for="user-avatar-upload" id="avatar-upload-label">Click to choose an image</label></div>
            <div class="setting-group"><label for="user-name-input">Display Name</label><input type="text" id="user-name-input" placeholder="E.g., Alex"></div>
            <div class="setting-group"><label for="user-form-select">Your Form/Level</label><select id="user-form-select"><option value="S1">Form 1 (S1)</option><option value="S2">Form 2 (S2)</option><option value="S3">Form 3 (S3)</option><option value="S4">Form 4 (S4)</option><option value="S5">Form 5 (S5)</option><option value="S6">Form 6 (S6)</option></select></div>
            <div class="setting-group"><label for="user-about-input">About Me</label><textarea id="user-about-input" placeholder="Describe your learning style, subjects, strengths, or weaknesses..."></textarea></div>
            <div class="modal-actions"><button id="save-profile-btn">Save</button></div>
        </div>
    </div>

    <script>
        const getEl = (id) => document.getElementById(id);
        const appContainer = getEl('app-container');
        const sidebar = getEl('sidebar');
        const chatHistoryUI = getEl('chat-history');
        const userInput = getEl('user-input');
        const sendBtn = getEl('send-btn');
        const newChatBtn = getEl('new-chat-btn');
        const historyListUI = getEl('history-list');
        const menuBtn = getEl('menu-btn');
        const settingsBtn = getEl('settings-btn');
        const settingsModal = getEl('settings-modal');
        const closeSettingsBtn = getEl('close-settings-btn');
        const modelSelect = getEl('model-select');
        const themeToggleBtn = getEl('theme-toggle-btn');
        const userProfileBtn = getEl('user-profile');
        const profileModal = getEl('profile-modal');
        const saveProfileBtn = getEl('save-profile-btn');
        const userNameInput = getEl('user-name-input');
        const userFormSelect = getEl('user-form-select');
        const userAboutInput = getEl('user-about-input');
        const avatarUploadInput = getEl('user-avatar-upload');
        const avatarPreview = getEl('avatar-preview');
        const profileAvatarUI = getEl('profile-avatar');
        const profileNameUI = getEl('profile-name');
        const welcomeModal = getEl('welcome-modal');
        const welcomeLetsGoBtn = getEl('welcome-lets-go-btn');

        // CHANGE THIS TO YOUR VERCEL API PATH
        const API_HANDLER_URL = '/api/chat'; 
        
        const HISTORY_STORAGE_KEY = 'aiLearningChatHistories_v10_local';
        const ACTIVE_CHAT_ID_KEY = 'aiLearningActiveChatId_v10_local';
        const MODEL_KEY = 'aiLearningModel_v10_local';
        const USER_PROFILE_KEY = 'aiLearningUserProfile_v10_local';
        const THEME_KEY = 'aiLearningTheme_v10_local';
        const FIRST_VISIT_KEY = 'aiLearningFirstVisit_v10_local';
        const AI_AVATAR_URL = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%238899a6'%3E%3Cpath d='M12 2a10 10 0 00-9.95 9.1c-.04.55.39 1 .95.95A10 10 0 0012 22a10 10 0 0010-10c0-5.52-4.48-10-10-10zm0 18a8 8 0 110-16 8 8 0 010 16zm-2-8a2 2 0 100-4 2 2 0 000 4zm4 0a2 2 0 100-4 2 2 0 000 4z'/%3E%3C/svg%3E`;
        
        let chatHistories = {};
        let activeChatId = null;
        let userProfile = { name: 'Student', form: 'S4', about: '', avatar: null };
        let newAvatarData = null;

        document.addEventListener('DOMContentLoaded', initialize);
        sendBtn.addEventListener('click', handleSendMessage);
        userInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSendMessage(); }});
        newChatBtn.addEventListener('click', createNewChat);
        userInput.addEventListener('input', () => { userInput.style.height = 'auto'; userInput.style.height = `${userInput.scrollHeight}px`; });
        menuBtn.addEventListener('click', () => { sidebar.classList.toggle('open'); appContainer.classList.toggle('menu-open'); });
        themeToggleBtn.addEventListener('click', toggleTheme);
        settingsBtn.addEventListener('click', () => settingsModal.classList.add('visible'));
        closeSettingsBtn.addEventListener('click', () => settingsModal.classList.remove('visible'));
        userProfileBtn.addEventListener('click', openProfileModal);
        saveProfileBtn.addEventListener('click', saveUserProfile);
        avatarUploadInput.addEventListener('change', handleAvatarUpload);
        [settingsModal, profileModal, welcomeModal].forEach(modal => modal.addEventListener('click', (e) => e.target === modal && modal.classList.remove('visible')));
        modelSelect.addEventListener('change', () => localStorage.setItem(MODEL_KEY, modelSelect.value));
        welcomeLetsGoBtn.addEventListener('click', () => { welcomeModal.classList.remove('visible'); openProfileModal(); });

        function initialize() {
            loadTheme();
            loadModelSelection();
            loadUserProfile();
            loadAllHistories();
            renderHistoryList();
            if (!localStorage.getItem(FIRST_VISIT_KEY)) {
                welcomeModal.classList.add('visible');
                localStorage.setItem(FIRST_VISIT_KEY, 'false');
            }
            const savedActiveId = localStorage.getItem(ACTIVE_CHAT_ID_KEY);
            if (savedActiveId && chatHistories[savedActiveId]) { loadChat(savedActiveId); }
            else if (Object.keys(chatHistories).length > 0) { loadChat(Object.keys(chatHistories)[0]); }
            else { createNewChat(); }
        }

        async function handleSendMessage() {
            const userText = userInput.value.trim();
            if (!userText || !activeChatId) return;
            const currentChat = chatHistories[activeChatId];
            addMessageToUI('user', userText, currentChat.messages.length);
            currentChat.messages.push({ role: 'user', content: userText });
            saveAllHistories();
            userInput.value = ''; userInput.style.height = 'auto';
            const loader = showLoader();
            try {
                const aiResponse = await callAiApi(currentChat.messages);
                loader.remove();
                addMessageToUI('ai', aiResponse, currentChat.messages.length);
                currentChat.messages.push({ role: 'assistant', content: aiResponse });
                saveAllHistories();
                await updateChatTitle(activeChatId);
            } catch (error) {
                loader.remove();
                addMessageToUI('ai', `Sorry, an error occurred: ${error.message}`);
            }
            renderHistoryList();
        }
        
        async function callAiApi(messages, isTitleGeneration = false) {
            const payload = { model: modelSelect.value, messages: messages, userProfile: userProfile, isTitleGeneration: isTitleGeneration };
            const response = await fetch(API_HANDLER_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) throw new Error(`Network error: ${response.status}`);
            const data = await response.json();
            if (data.status === 'success') return data.content;
            else throw new Error(`AI Error: ${data.message || 'Unknown error'}`);
        }

        async function updateChatTitle(chatId) {
            const chat = chatHistories[chatId];
            if (!chat || chat.messages.length === 0) return;
            const titlePrompt = "Based on our conversation, create a very short, concise title (4-5 words maximum). Respond with ONLY the title itself, without any introductory text, explanation, or quotation marks.";
            const titleMessages = [...chat.messages, { role: 'user', content: titlePrompt }];
            try {
                const rawTitle = await callAiApi(titleMessages, true);
                const newTitle = rawTitle.replace(/["'.]/g, '').trim();
                if (newTitle && newTitle.length > 0 && newTitle.length < 100) { chat.title = newTitle; saveAllHistories(); }
            } catch (error) { console.error("Failed to generate chat title:", error); }
        }
        
        async function handleResendFrom(index) {
            const chat = chatHistories[activeChatId];
            chat.messages.length = index + 1;
            saveAllHistories();
            loadChat(activeChatId);
            const loader = showLoader();
            try {
                const aiResponse = await callAiApi(chat.messages);
                loader.remove();
                addMessageToUI('ai', aiResponse, chat.messages.length);
                chat.messages.push({ role: 'assistant', content: aiResponse });
                saveAllHistories();
                await updateChatTitle(activeChatId);
            } catch (error) {
                loader.remove();
                addMessageToUI('ai', `Sorry, an error occurred: ${error.message}`);
            }
            renderHistoryList();
        }

        function addMessageToUI(sender, text, index) {
            const wrapper = document.createElement('div');
            wrapper.className = `message-wrapper ${sender}-message-wrapper`;
            wrapper.dataset.index = index;
            const avatar = document.createElement('img');
            avatar.className = 'chat-avatar';
            avatar.src = sender === 'user' ? (userProfile.avatar || generateDefaultAvatar(userProfile.name)) : AI_AVATAR_URL;
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            const dirtyHtml = marked.parse(text, { breaks: true });
            messageDiv.innerHTML = DOMPurify.sanitize(dirtyHtml);
            messageContent.appendChild(messageDiv);
            if (sender === 'user') {
                const actions = document.createElement('div');
                actions.className = 'message-actions';
                actions.innerHTML = `<button title="Edit & Resend"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828zM3 17a2 2 0 012-2h12a2 2 0 110 4H5a2 2 0 01-2-2z"/></svg></button><button title="Delete"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M6 2l2-2h4l2 2h4v2H2V2h4zM3 6h14l-1 14H4L3 6zm5 2v10h1V8H8zm3 0v10h1V8h-1z"/></svg></button>`;
                actions.children[0].onclick = () => handleEditPrompt(index);
                actions.children[1].onclick = () => handleDeletePrompt(index);
                messageContent.appendChild(actions);
            }
            wrapper.append(avatar, messageContent);
            chatHistoryUI.appendChild(wrapper);
            scrollToBottom();
        }

        function handleEditPrompt(index) {
            const wrapper = document.querySelector(`.message-wrapper[data-index='${index}']`);
            if (!wrapper) return;
            const messageDiv = wrapper.querySelector('.message');
            const originalText = chatHistories[activeChatId].messages[index].content;
            const editArea = document.createElement('div');
            editArea.className = 'edit-prompt-area';
            const textarea = document.createElement('textarea');
            textarea.rows = 3;
            textarea.value = originalText;
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'edit-prompt-actions';
            const saveBtn = document.createElement('button');
            saveBtn.textContent = 'Save & Resend';
            saveBtn.className = 'edit-prompt-save';
            saveBtn.onclick = () => {
                const newText = textarea.value.trim();
                if (newText && newText !== originalText) {
                    chatHistories[activeChatId].messages[index].content = newText;
                    handleResendFrom(index);
                } else {
                    messageDiv.style.display = 'block';
                    wrapper.querySelector('.message-actions').style.display = 'flex';
                    editArea.remove();
                }
            };
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'Cancel';
            cancelBtn.className = 'edit-prompt-cancel';
            cancelBtn.onclick = () => { messageDiv.style.display = 'block'; wrapper.querySelector('.message-actions').style.display = 'flex'; editArea.remove(); };
            actionsDiv.append(cancelBtn, saveBtn);
            editArea.append(textarea, actionsDiv);
            messageDiv.style.display = 'none';
            wrapper.querySelector('.message-actions').style.display = 'none';
            messageDiv.parentElement.appendChild(editArea);
            textarea.focus();
        }

        function handleDeletePrompt(index) {
             if (confirm('Delete this message and all that follow?')) {
                chatHistories[activeChatId].messages.length = index;
                saveAllHistories();
                loadChat(activeChatId);
            }
        }

        function showLoader() {
            const wrapper = document.createElement('div');
            wrapper.id = 'loader';
            wrapper.className = 'message-wrapper ai-message-wrapper';
            const avatar = document.createElement('img');
            avatar.className = 'chat-avatar';
            avatar.src = AI_AVATAR_URL;
            const loaderMessage = document.createElement('div');
            loaderMessage.className = 'message';
            loaderMessage.innerHTML = `<div style="display:flex;gap:5px;"><div style="width:8px;height:8px;background-color:var(--subtle-text-color);border-radius:50%;animation:bounce 1.2s infinite ease-in-out;"></div><div style="width:8px;height:8px;background-color:var(--subtle-text-color);border-radius:50%;animation:bounce 1.2s infinite ease-in-out .15s;"></div><div style="width:8px;height:8px;background-color:var(--subtle-text-color);border-radius:50%;animation:bounce 1.2s infinite ease-in-out .3s;"></div></div><style>@keyframes bounce{0%,80%,100%{transform:scale(0)}40%{transform:scale(1)}}</style>`;
            wrapper.append(avatar, loaderMessage);
            chatHistoryUI.appendChild(wrapper);
            scrollToBottom();
            return wrapper;
        }

        function scrollToBottom() { chatHistoryUI.scrollTop = chatHistoryUI.scrollHeight; }

        function createNewChat() {
            const newId = `chat-${Date.now()}`;
            chatHistories[newId] = { title: 'New Chat', messages: [] };
            setActiveChat(newId);
            chatHistoryUI.innerHTML = '';
            addMessageToUI('ai', "Hello! Let's start a new topic. What would you like to study?");
            saveAllHistories(); 
            renderHistoryList();
        }

        function loadChat(chatId) {
            setActiveChat(chatId);
            chatHistoryUI.innerHTML = '';
            const chat = chatHistories[chatId];
            if (!chat) return;
            const messages = chat.messages || [];
            if (messages.length === 0) { addMessageToUI('ai', "This is a new chat. What's on your mind?"); }
            else { messages.forEach((msg, index) => addMessageToUI(msg.role === 'user' ? 'user' : 'ai', msg.content, index)); }
            renderHistoryList();
        }

        function setActiveChat(chatId) {
            activeChatId = chatId;
            localStorage.setItem(ACTIVE_CHAT_ID_KEY, chatId);
            if (sidebar.classList.contains('open')) { sidebar.classList.remove('open'); appContainer.classList.remove('menu-open'); }
        }

        function renderHistoryList() {
            historyListUI.innerHTML = '';
            Object.keys(chatHistories).sort().reverse().forEach(chatId => {
                const chat = chatHistories[chatId];
                if (!chat) return;
                const li = document.createElement('li');
                li.className = 'history-item';
                li.dataset.chatId = chatId;
                if (chatId === activeChatId) li.classList.add('active');
                const titleSpan = document.createElement('span');
                titleSpan.className = 'history-item-title';
                titleSpan.textContent = chat.title || 'New Chat';
                titleSpan.onclick = () => loadChat(chatId);
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'history-item-actions';
                actionsDiv.innerHTML = `<button title="Rename"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828zM3 17a2 2 0 012-2h12a2 2 0 110 4H5a2 2 0 01-2-2z"/></svg></button><button title="Delete"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M6 2l2-2h4l2 2h4v2H2V2h4zM3 6h14l-1 14H4L3 6zm5 2v10h1V8H8zm3 0v10h1V8h-1z"/></svg></button>`;
                actionsDiv.children[0].onclick = (e) => { e.stopPropagation(); handleEditTitle(chatId, titleSpan); };
                actionsDiv.children[1].onclick = (e) => { e.stopPropagation(); handleDeleteChat(chatId); };
                li.append(titleSpan, actionsDiv);
                historyListUI.appendChild(li);
            });
        }
        
        function handleEditTitle(chatId, titleSpan) {
            const currentTitle = chatHistories[chatId].title;
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentTitle;
            input.className = 'history-title-input';
            const save = () => {
                const newTitle = input.value.trim();
                if (newTitle && newTitle !== currentTitle) { chatHistories[chatId].title = newTitle; saveAllHistories(); }
                renderHistoryList();
            };
            input.onblur = save;
            input.onkeydown = (e) => { if (e.key === 'Enter') input.blur(); if (e.key === 'Escape') { input.value = currentTitle; input.blur(); }};
            titleSpan.parentElement.replaceChild(input, titleSpan);
            input.focus();
            input.select();
        }

        function handleDeleteChat(chatId) {
            if (confirm(`Are you sure you want to delete "${chatHistories[chatId].title}"?`)) {
                delete chatHistories[chatId];
                saveAllHistories();
                if (activeChatId === chatId) {
                    activeChatId = null;
                    const remainingChats = Object.keys(chatHistories);
                    if (remainingChats.length > 0) { loadChat(remainingChats[0]); }
                    else { createNewChat(); }
                } else { renderHistoryList(); }
            }
        }
        
        function toggleTheme() {
            const newTheme = document.body.dataset.theme === 'dark' ? 'light' : 'dark';
            document.body.dataset.theme = newTheme;
            localStorage.setItem(THEME_KEY, newTheme);
        }

        function openProfileModal() {
            userNameInput.value = userProfile.name;
            userFormSelect.value = userProfile.form;
            userAboutInput.value = userProfile.about;
            avatarPreview.src = userProfile.avatar || generateDefaultAvatar(userProfile.name);
            newAvatarData = null;
            profileModal.classList.add('visible');
        }

        function handleAvatarUpload(event) {
            const file = event.target.files[0];
            if (!file || !file.type.startsWith('image/')) return;
            const reader = new FileReader();
            reader.onload = (e) => { newAvatarData = e.target.result; avatarPreview.src = newAvatarData; };
            reader.readAsDataURL(file);
        }

        function saveUserProfile() {
            userProfile.name = userNameInput.value.trim() || 'Student';
            userProfile.form = userFormSelect.value;
            userProfile.about = userAboutInput.value.trim();
            if (newAvatarData) userProfile.avatar = newAvatarData;
            else if (!userProfile.avatar) userProfile.avatar = generateDefaultAvatar(userProfile.name);
            localStorage.setItem(USER_PROFILE_KEY, JSON.stringify(userProfile));
            renderUserProfile();
            profileModal.classList.remove('visible');
        }

        function renderUserProfile() {
            profileNameUI.textContent = userProfile.name;
            profileAvatarUI.src = userProfile.avatar || generateDefaultAvatar(userProfile.name);
        }
        
        function generateDefaultAvatar(name) { return `https://api.dicebear.com/8.x/initials/svg?seed=${encodeURIComponent(name)}`; }

        function saveAllHistories() { localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(chatHistories)); }
        function loadAllHistories() { 
            const saved = localStorage.getItem(HISTORY_STORAGE_KEY); 
            const loaded = saved ? JSON.parse(saved) : {};
            chatHistories = loaded;
        }
        function loadTheme() { document.body.dataset.theme = localStorage.getItem(THEME_KEY) || 'dark'; }
        function loadModelSelection() { modelSelect.value = localStorage.getItem(MODEL_KEY) || 'gemini-2.5-pro'; }
        function loadUserProfile() {
            const saved = localStorage.getItem(USER_PROFILE_KEY);
            if (saved) userProfile = JSON.parse(saved);
            renderUserProfile();
        }
    </script>
</body>
</html>
