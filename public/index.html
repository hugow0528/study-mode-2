<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Study Guide | HKDSE</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+HK:wght@300;400;500;700&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>

    <style>
        :root {
            /* Dark Mode (Default) */
            --bg-main: #1C1C1E;
            --bg-sidebar: #151517;
            --bg-card: #2C2C2E;
            --text-primary: #E5E5E7;
            --text-secondary: #8E8E93;
            --accent: #0A84FF;
            --border: #38383A;
            --msg-user: #0A84FF;
            --msg-ai: #2C2C2E;
        }

        /* Light Mode (Wabi-sabi / Natural) */
        [data-theme="light"] {
            --bg-main: #F2F1F6;
            --bg-sidebar: #FFFFFF;
            --bg-card: #FFFFFF;
            --text-primary: #1C1C1E;
            --text-secondary: #8E8E93;
            --accent: #007AFF;
            --border: #E5E5EA;
            --msg-user: #007AFF;
            --msg-ai: #FFFFFF;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Noto Sans HK', sans-serif; background: var(--bg-main); color: var(--text-primary); height: 100dvh; display: flex; overflow: hidden; transition: background 0.3s; }
        
        /* Sidebar */
        #sidebar { width: 280px; background: var(--bg-sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; transition: transform 0.3s ease, background 0.3s; z-index: 100; flex-shrink: 0; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border); }
        .new-chat-btn { width: 100%; padding: 12px; background: var(--accent); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
        
        #history-list { list-style: none; padding: 10px; margin: 0; overflow-y: auto; flex: 1; }
        .history-item { padding: 12px; margin-bottom: 4px; border-radius: 8px; cursor: pointer; color: var(--text-secondary); display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; transition: background 0.2s; }
        .history-item:hover, .history-item.active { background: var(--bg-card); color: var(--text-primary); }
        .history-item.active { font-weight: 500; border-left: 3px solid var(--accent); }
        
        .history-title { flex: 1; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; padding-right: 10px; }
        .history-input { background: var(--bg-main); border: 1px solid var(--accent); color: var(--text-primary); width: 100%; padding: 4px; border-radius: 4px; font-size: 0.9rem; }
        .item-actions { display: none; gap: 5px; }
        .history-item:hover .item-actions, .history-item.active .item-actions { display: flex; }
        .icon-btn { background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 2px; }
        .icon-btn:hover { color: var(--text-primary); }

        .sidebar-footer { padding: 15px; border-top: 1px solid var(--border); display: flex; gap: 10px; align-items: center; cursor: pointer; }
        
        /* Main Chat */
        #main { flex: 1; display: flex; flex-direction: column; position: relative; width: 100%; }
        
        .top-bar { padding: 15px 20px; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid var(--border); background: var(--bg-main); z-index: 10; justify-content: space-between; }
        .model-selector { background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border); padding: 8px 12px; border-radius: 8px; font-size: 0.9rem; outline: none; }
        .theme-btn { background: none; border: none; cursor: pointer; font-size: 1.2rem; }

        #chat-container { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 120px; scroll-behavior: smooth; }
        
        .message-row { display: flex; margin-bottom: 24px; gap: 12px; animation: fadeIn 0.3s ease; width: 100%; }
        .message-row.user { flex-direction: row-reverse; }
        
        .avatar { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; flex-shrink: 0; background: var(--bg-card); border: 1px solid var(--border); }
        
        .message-content-wrapper { max-width: 80%; display: flex; flex-direction: column; gap: 4px; }
        .user .message-content-wrapper { align-items: flex-end; }
        
        .message-bubble { padding: 12px 18px; border-radius: 18px; line-height: 1.6; font-size: 1rem; position: relative; word-wrap: break-word; }
        .user .message-bubble { background: var(--msg-user); color: white; border-bottom-right-radius: 4px; }
        .ai .message-bubble { background: var(--msg-ai); color: var(--text-primary); border-bottom-left-radius: 4px; border: 1px solid var(--border); }

        /* Edit Button */
        .edit-msg-btn { font-size: 0.75rem; color: var(--text-secondary); background: none; border: none; cursor: pointer; opacity: 0; transition: opacity 0.2s; align-self: flex-end; }
        .message-row:hover .edit-msg-btn { opacity: 1; }
        .user .edit-msg-btn { align-self: flex-start; }

        /* Markdown */
        .message-bubble code { font-family: 'JetBrains Mono', monospace; font-size: 0.9em; background: rgba(0,0,0,0.2); padding: 2px 4px; border-radius: 4px; }
        [data-theme="light"] .message-bubble code { background: rgba(0,0,0,0.05); }
        .message-bubble pre { background: #111; padding: 15px; border-radius: 10px; overflow-x: auto; margin: 10px 0; color: #ddd; }
        
        /* Input Area */
        .input-area { position: absolute; bottom: 0; left: 0; right: 0; padding: 20px; background: linear-gradient(to top, var(--bg-main) 90%, transparent); display: flex; justify-content: center; }
        .input-wrapper { width: 100%; max-width: 800px; background: var(--bg-card); border-radius: 24px; padding: 10px 16px; display: flex; align-items: flex-end; gap: 10px; border: 1px solid var(--border); box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        textarea { flex: 1; background: transparent; border: none; color: var(--text-primary); resize: none; max-height: 150px; padding: 10px 0; font-size: 1rem; outline: none; line-height: 1.5; }
        .send-btn { background: var(--accent); color: white; border: none; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; }
        .send-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Modal */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 2000; }
        .modal.active { opacity: 1; pointer-events: all; }
        .modal-content { background: var(--bg-sidebar); padding: 30px; border-radius: 20px; width: 90%; max-width: 400px; border: 1px solid var(--border); color: var(--text-primary); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 0.9rem; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; background: var(--bg-main); border: 1px solid var(--border); color: var(--text-primary); padding: 10px; border-radius: 8px; }
        .save-btn { width: 100%; padding: 12px; background: var(--accent); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        
        .avatar-preview { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin: 0 auto 10px; display: block; border: 2px solid var(--border); }
        .file-upload { display: block; margin: 0 auto; width: 100%; text-align: center; }

        @media (max-width: 768px) {
            #sidebar { position: fixed; left: -280px; height: 100%; }
            #sidebar.open { transform: translateX(280px); }
            .menu-btn { display: block; }
        }
    </style>
</head>
<body data-theme="dark">

    <aside id="sidebar">
        <div class="sidebar-header">
            <button class="new-chat-btn" onclick="createNewChat()">+ New Chat</button>
        </div>
        <ul id="history-list"></ul>
        <div class="sidebar-footer" onclick="openProfile()">
            <img src="" id="sidebar-avatar" class="avatar">
            <div style="flex:1; overflow:hidden;">
                <div id="profile-name" style="font-weight:600; font-size:0.95rem;">Student</div>
            </div>
            <span style="color:var(--text-secondary)">‚öôÔ∏è</span>
        </div>
    </aside>

    <main id="main">
        <div class="top-bar">
            <button class="menu-btn" onclick="toggleSidebar()" style="background:none;border:none;color:var(--text-primary);font-size:1.5rem;display:none;">‚ò∞</button>
            <div style="font-weight:600;">STUDY MODE</div>
            <div style="display:flex; gap:10px;">
                <button class="theme-btn" onclick="toggleTheme()" id="theme-icon">‚òÄÔ∏è</button>
                <select id="model-select" class="model-selector">
                    <optgroup label="Google">
                        <option value="gemini-3-pro-preview">Gemini 3 Pro</option>
                        <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
                    </optgroup>
                    <optgroup label="Cerebras">
                        <option value="llama-3.3-70b">Llama 3.3 70B</option>
                        <option value="qwen-3-32b">Qwen 3 32B</option>
                    </optgroup>
                </select>
            </div>
        </div>

        <div id="chat-container"></div>

        <div class="input-area">
            <div class="input-wrapper">
                <textarea id="user-input" placeholder="Type a message..." rows="1"></textarea>
                <button id="send-btn" class="send-btn" onclick="sendMessage()">‚û§</button>
            </div>
        </div>
    </main>

    <!-- Profile Modal -->
    <div id="profile-modal" class="modal">
        <div class="modal-content">
            <h2 style="text-align:center; margin-top:0;">Profile</h2>
            <img id="modal-avatar-preview" class="avatar-preview" src="">
            <div class="form-group">
                <input type="file" id="avatar-upload" class="file-upload" accept="image/*">
            </div>
            <div class="form-group"><label>Name</label><input type="text" id="p-name"></div>
            <div class="form-group"><label>Form</label><select id="p-form"><option>S4</option><option>S5</option><option>S6</option></select></div>
            <div class="form-group"><label>About Me</label><textarea id="p-about" rows="2"></textarea></div>
            <button class="save-btn" onclick="saveProfile()">Save</button>
        </div>
    </div>

    <script>
        // Constants & State
        const AI_AVATAR = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%238899a6'%3E%3Cpath d='M12 2a10 10 0 00-9.95 9.1c-.04.55.39 1 .95.95A10 10 0 0012 22a10 10 0 0010-10c0-5.52-4.48-10-10-10zm0 18a8 8 0 110-16 8 8 0 010 16zm-2-8a2 2 0 100-4 2 2 0 000 4zm4 0a2 2 0 100-4 2 2 0 000 4z'/%3E%3C/svg%3E";
        const DEFAULT_USER_AVATAR = "https://api.dicebear.com/7.x/initials/svg?seed=Student";
        
        let chatHistories = JSON.parse(localStorage.getItem('hkdse_chats')) || {};
        let activeChatId = null;
        let userProfile = JSON.parse(localStorage.getItem('hkdse_profile')) || { name: 'Student', form: 'S5', about: '', avatar: '' };
        let theme = localStorage.getItem('hkdse_theme') || 'dark';

        // Elements
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const modelSelect = document.getElementById('model-select');

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            applyTheme(theme);
            loadProfileUI();
            renderHistoryList();
            
            userInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });
            userInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
            });

            // Restore Chat
            const lastId = localStorage.getItem('hkdse_active_id');
            if(lastId && chatHistories[lastId]) loadChat(lastId);
            else createNewChat();
        });

        // --- Theme Logic ---
        function toggleTheme() {
            theme = theme === 'dark' ? 'light' : 'dark';
            localStorage.setItem('hkdse_theme', theme);
            applyTheme(theme);
        }
        function applyTheme(t) {
            document.body.setAttribute('data-theme', t);
            document.getElementById('theme-icon').innerText = t === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        }

        // --- Chat Logic ---
        function createNewChat() {
            const id = Date.now().toString();
            chatHistories[id] = { title: 'New Chat', messages: [], model: modelSelect.value };
            loadChat(id);
            renderHistoryList();
        }

        function loadChat(id) {
            activeChatId = id;
            localStorage.setItem('hkdse_active_id', id);
            if(chatHistories[id].model) modelSelect.value = chatHistories[id].model;
            renderChatUI();
            // Close sidebar on mobile
            document.getElementById('sidebar').classList.remove('open');
        }

        function renderChatUI() {
            chatContainer.innerHTML = '';
            const messages = chatHistories[activeChatId].messages;
            if (messages.length === 0) {
                // Intro Message
                const introDiv = document.createElement('div');
                introDiv.className = 'message-row ai';
                introDiv.innerHTML = `
                    <img src="${AI_AVATAR}" class="avatar">
                    <div class="message-content-wrapper">
                        <div class="message-bubble">Hello ${userProfile.name}! Êàë‰øÇ‰Ω†ÂòÖ Study Partner„ÄÇ‰ªäÊó•Ê∫´Âí©Ôºü</div>
                    </div>`;
                chatContainer.appendChild(introDiv);
            } else {
                messages.forEach((msg, index) => appendMessageUI(msg.role, msg.content, index));
            }
            scrollToBottom();
        }

        function appendMessageUI(role, text, index) {
            const div = document.createElement('div');
            div.className = `message-row ${role === 'user' ? 'user' : 'ai'}`;
            
            const imgSrc = role === 'user' ? (userProfile.avatar || DEFAULT_USER_AVATAR) : AI_AVATAR;
            
            const bubbleContent = role === 'ai' ? DOMPurify.sanitize(marked.parse(text)) : text.replace(/\n/g, '<br>');

            let editBtnHTML = '';
            if (role === 'user') {
                editBtnHTML = `<button class="edit-msg-btn" onclick="editMessage(${index})">Edit</button>`;
            }

            div.innerHTML = `
                <img src="${imgSrc}" class="avatar">
                <div class="message-content-wrapper">
                    <div class="message-bubble">${bubbleContent}</div>
                    ${editBtnHTML}
                </div>
            `;
            
            chatContainer.appendChild(div);
            scrollToBottom();
        }

        function scrollToBottom() { chatContainer.scrollTop = chatContainer.scrollHeight; }

        // --- Core Messaging ---
        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text) return;

            userInput.value = '';
            userInput.style.height = 'auto';
            
            const currentChat = chatHistories[activeChatId];
            const msgIndex = currentChat.messages.length;
            
            // 1. UI: User Message
            currentChat.messages.push({ role: 'user', content: text });
            currentChat.model = modelSelect.value;
            appendMessageUI('user', text, msgIndex);
            
            // 2. UI: Loading
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message-row ai';
            loadingDiv.id = 'loading-bubble';
            loadingDiv.innerHTML = `<img src="${AI_AVATAR}" class="avatar"><div class="message-bubble">Thinking...</div>`;
            chatContainer.appendChild(loadingDiv);
            scrollToBottom();
            sendBtn.disabled = true;

            try {
                // 3. API Call
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: modelSelect.value,
                        messages: currentChat.messages,
                        userProfile: userProfile,
                        isTitleGeneration: false
                    })
                });

                const data = await response.json();
                loadingDiv.remove();

                if (data.status === 'success') {
                    currentChat.messages.push({ role: 'assistant', content: data.content });
                    appendMessageUI('ai', data.content, msgIndex + 1);
                    
                    // 4. Auto Rename (Background)
                    generateAutoTitle();
                } else {
                    appendMessageUI('ai', `‚ö†Ô∏è Error: ${data.message}`, -1);
                }

            } catch (err) {
                loadingDiv.remove();
                appendMessageUI('ai', `‚ö†Ô∏è Network Error`, -1);
            }

            saveHistory();
            sendBtn.disabled = false;
        }

        // --- Edit Message Logic ---
        function editMessage(index) {
            const chat = chatHistories[activeChatId];
            const msgToEdit = chat.messages[index];
            
            // 1. Put text back in input
            userInput.value = msgToEdit.content;
            userInput.focus();
            
            // 2. Delete this message and everything after it
            chat.messages = chat.messages.slice(0, index);
            
            // 3. Re-render UI
            renderChatUI();
            saveHistory();
        }

        // --- Title Logic ---
        async function generateAutoTitle() {
            const chat = chatHistories[activeChatId];
            // Only generate if messages > 2 to save calls, or every time if you prefer
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: 'gemini-2.5-flash-lite', // Use cheap model for titles
                        messages: chat.messages,
                        isTitleGeneration: true
                    })
                });
                const data = await response.json();
                if(data.status === 'success' && data.content) {
                    chat.title = data.content.trim().substring(0, 30); // Limit length
                    saveHistory();
                    renderHistoryList();
                }
            } catch(e) { console.log('Title Gen Error', e); }
        }

        function manualRename(id, newTitle) {
            if(chatHistories[id]) {
                chatHistories[id].title = newTitle;
                saveHistory();
                renderHistoryList(); // Re-render to remove input box
            }
        }

        function showRenameInput(id) {
            const item = document.querySelector(`.history-item[onclick="loadChat('${id}')"]`);
            if(item) {
                const currentTitle = chatHistories[id].title;
                item.innerHTML = `
                    <input type="text" class="history-input" value="${currentTitle}" 
                    onblur="manualRename('${id}', this.value)" 
                    onkeydown="if(event.key==='Enter') manualRename('${id}', this.value)">
                `;
                item.querySelector('input').focus();
                item.onclick = null; // Prevent click from reloading chat while editing
            }
        }

        function deleteChat(e, id) {
            e.stopPropagation();
            if(confirm('Delete?')) {
                delete chatHistories[id];
                saveHistory();
                if(activeChatId === id) createNewChat();
                else renderHistoryList();
            }
        }

        function renderHistoryList() {
            const list = document.getElementById('history-list');
            list.innerHTML = Object.keys(chatHistories).sort().reverse().map(id => `
                <li class="history-item ${id === activeChatId ? 'active' : ''}" onclick="loadChat('${id}')">
                    <span class="history-title">${chatHistories[id].title}</span>
                    <div class="item-actions">
                        <button class="icon-btn" onclick="event.stopPropagation(); showRenameInput('${id}')">‚úé</button>
                        <button class="icon-btn" onclick="deleteChat(event, '${id}')">√ó</button>
                    </div>
                </li>
            `).join('');
        }

        // --- Profile & Avatar ---
        function openProfile() {
            document.getElementById('p-name').value = userProfile.name;
            document.getElementById('p-form').value = userProfile.form;
            document.getElementById('p-about').value = userProfile.about;
            document.getElementById('modal-avatar-preview').src = userProfile.avatar || DEFAULT_USER_AVATAR;
            document.getElementById('profile-modal').classList.add('active');
        }

        // Handle Image Upload & Resize (Client Side)
        document.getElementById('avatar-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if(!file) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    // Resize to 100x100 to save LocalStorage space
                    canvas.width = 100;
                    canvas.height = 100;
                    ctx.drawImage(img, 0, 0, 100, 100);
                    const base64 = canvas.toDataURL('image/jpeg', 0.8);
                    
                    document.getElementById('modal-avatar-preview').src = base64;
                    userProfile.tempAvatar = base64; // Temp store
                }
                img.src = event.target.result;
            }
            reader.readAsDataURL(file);
        });

        function saveProfile() {
            userProfile.name = document.getElementById('p-name').value;
            userProfile.form = document.getElementById('p-form').value;
            userProfile.about = document.getElementById('p-about').value;
            if(userProfile.tempAvatar) {
                userProfile.avatar = userProfile.tempAvatar;
                delete userProfile.tempAvatar;
            }
            
            localStorage.setItem('hkdse_profile', JSON.stringify(userProfile));
            loadProfileUI();
            document.getElementById('profile-modal').classList.remove('active');
            renderChatUI(); // Update avatars in current chat
        }

        function loadProfileUI() {
            document.getElementById('profile-name').innerText = userProfile.name;
            document.getElementById('sidebar-avatar').src = userProfile.avatar || DEFAULT_USER_AVATAR;
        }

        function saveHistory() { localStorage.setItem('hkdse_chats', JSON.stringify(chatHistories)); }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
        document.getElementById('profile-modal').addEventListener('click', (e) => {
            if (e.target.id === 'profile-modal') e.target.classList.remove('active');
        });
    </script>
</body>
</html>
